name: Run Newman Tests on Render API

on:
  push:
    branches:
      - main    # or your default branch
  workflow_dispatch: # allows manual run from Actions tab
    # schedule:
    # - cron: '0 * * * *'  # runs every hour

jobs:
  run-newman-tests:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ›  Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ðŸ“¦ Install project dependencies (faker included)
      run: npm install

    - name: ðŸ“¦ Install Newman
      run: npm install -g newman

    - name: ðŸ§ª Generate CSV file
      run: node generate-csv.js

    - name: âœ… Run Newman tests
      run: |
        npx newman run upload-collection.json \
          --env-var base_url=https://playing-with-api.onrender.com \
          --env-var file=@temp.csv
          --reporters cli,json \
          --reporter-json-export newman-report.json

    - name: ðŸ“² Send Telegram Notification
      if: always()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
        -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
        -d parse_mode=Markdown \
        -d text="ðŸ§ª *Newman Test Run Completed*
        *Status:* ${{ job.status }}
        *Repo:* ${{ github.repository }}
        *Actor:* ${{ github.actor }}
        *Time:* $(date -u)"
